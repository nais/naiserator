---
apiVersion: "apiextensions.k8s.io/v1beta1"
kind: "CustomResourceDefinition"
metadata:
  name: "applications.nais.io"
spec:
  group: "nais.io"
  version: "v1alpha1"
  scope: "Namespaced"
  names:
    plural: "applications"
    singular: "application"
    kind: "Application"
    shortNames:
    - app
  additionalPrinterColumns:
    - name: Age
      type: date
      JSONPath: .metadata.creationTimestamp
    - name: Team
      type: string
      JSONPath: .metadata.labels.team
  validation:
    openAPIV3Schema:
      properties:
        metadata:
          required:
            - labels
          properties:
            labels:
              required:
                - team
              properties:
                team:
                  type: string
        spec:
          required:
          - image
          properties:
            image:
              type: string
            replicas:
              properties:
                min:
                  type: integer
                max:
                  type: integer
                cpuThresholdPercentage:
                  type: integer
            port:
              type: integer
            strategy:
              required:
                - type
              properties:
                type:
                  type: string
                  enum:
                    - "Recreate"
                    - "RollingUpdate"
            liveness:
              required:
              - path
              properties:
                path:
                  type: string
                port:
                  type: integer
                initialDelay:
                  type: integer
                timeout:
                  type: integer
                periodSeconds:
                  type: integer
                failureThreshold:
                  type: integer
            readiness:
              required:
              - path
              properties:
                path:
                  type: string
                port:
                  type: integer
                initialDelay:
                  type: integer
                timeout:
                  type: integer
            leaderElection:
              type: boolean
            preStopHookPath:
              type: string
            prometheus:
              type: object
              properties:
                enabled:
                  type: boolean
                path:
                  type: string
            resources:
              properties:
                limits:
                  properties:
                    cpu:
                      type: string
                      pattern: '^\d+m?$'
                    memory:
                      type: string
                      pattern: '^\d+[KMG]i$'
                requests:
                  properties:
                    cpu:
                      type: string
                      pattern: '^\d+m?$'
                    memory:
                      type: string
                      pattern: '^\d+[KMG]i$'
            ingresses:
              type: array
              items:
                type: string
            logformat:
              type: string
              enum:
                - ""
                - "accesslog"
                - "accesslog_with_processing_time"
                - "accesslog_with_referer_useragent"
                - "capnslog"
                - "logrus"
                - "gokit"
                - "redis"
                - "glog"
                - "simple"
                - "influxdb"
                - "log15"
            logtransform:
              type: string
            secureLogs:
              type: object
              properties:
                enabled:
                  type: boolean
            webproxy:
              type: boolean
            secrets:
              type: array
              items:
                type: object
                required:
                  - name
                properties:
                  name:
                    type: string
                  type:
                    type: string
                    enum:
                      - "env"
                      - "files"
                  mountPath:
                    type: string
            vault:
              type: object
              properties:
                enabled:
                  type: boolean
                sidecar:
                  type: boolean
                paths:
                  type: array
                  items:
                    type: object
                    required:
                      - kvPath
                      - mountPath
                    properties:
                      kvPath:
                        type: string
                      mountPath:
                        type: string
            configMaps:
              properties:
                files:
                  type: array
            env:
              type: array
              items:
                type: object
                required:
                  - name
                properties:
                  name:
                    type: string
                  value:
                    type: string
                  valueFrom:
                    type: object
                    required:
                      - fieldRef
                    properties:
                      fieldRef:
                        type: object
                        required:
                          - fieldPath
                        properties:
                          fieldPath:
                            type: string
                            # https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.14/#envvarsource-v1-core
                            enum:
                              - ""
                              - "metadata.name"
                              - "metadata.namespace"
                              - "metadata.labels"
                              - "metadata.annotations"
                              - "spec.nodeName"
                              - "spec.serviceAccountName"
                              - "status.hostIP"
                              - "status.podIP"
            service:
              properties:
                port:
                  type: integer
            accessPolicy:
              properties:
                allowAllIngress:
                  type: boolean
                allowAllEgress:
                  type: boolean
                ingress:
                  properties:
                    allowAll:
                      type: boolean
                    rules:
                      type: array
                      items:
                        type: object
                        required:
                          - application
                        properties:
                          application:
                            type: string
                          namespace:
                            type: string
                egress:
                  properties:
                    allowAll:
                      type: boolean
                    rules:
                      type: array
                      items:
                        type: object
                        required:
                          - application
                        properties:
                          application:
                            type: string
                          namespace:
                            type: string
