testconfig:
  description: vanilla minimal naisjob with schedule running on-premises with default configuration

config:
  cluster-name: test-cluster
  features:
    nav-ca-bundle: true

input:
  kind: Naisjob
  apiVersion: nais.io/v1
  metadata:
    name: mynaisjob
    namespace: mynamespace
    uid: "123456"
    annotations:
      nais.io/deploymentCorrelationID: corr
    labels:
      team: myteam
  spec:
    image: navikt/mynaisjob:1.2.3
    schedule: "* 2 * * *"

tests:
  - match:
      - type: subset
        name: "common metadata"
        resource:
          metadata:
            annotations:
              nais.io/deploymentCorrelationID: corr
            labels:
              app: mynaisjob
              team: myteam
            ownerReferences:
              - apiVersion: nais.io/v1
                kind: Naisjob
                name: mynaisjob
                uid: "123456"

  - operation: CreateIfNotExists
    apiVersion: v1
    kind: ServiceAccount
    name: mynaisjob
    match:
      - type: subset
        name: "service account created"
        resource: {}

  - operation: CreateOrUpdate
    apiVersion: batch/v1
    kind: CronJob
    name: mynaisjob
    match:
      - name: "naisjob created"
        type: exact
        exclude:
          - .metadata
          - .status
          - .spec.jobTemplate.metadata.creationTimestamp
          - .spec.jobTemplate.spec.template.metadata.creationTimestamp
        resource:
          spec:
            concurrencyPolicy: Allow
            failedJobsHistoryLimit: 1
            jobTemplate:
              metadata:
                annotations:
                  nais.io/deploymentCorrelationID: corr
                labels:
                  app: mynaisjob
                  team: myteam
                name: mynaisjob
                namespace: mynamespace
                ownerReferences:
                  - apiVersion: nais.io/v1
                    kind: Naisjob
                    name: mynaisjob
                    uid: "123456"
              spec:
                backoffLimit: 6
                template:
                  metadata:
                    annotations:
                      kubectl.kubernetes.io/default-container: mynaisjob
                    labels:
                      app: mynaisjob
                      team: myteam
                      nais.io/naisjob: "true"
                    name: mynaisjob
                    namespace: mynamespace
                    ownerReferences:
                      - apiVersion: nais.io/v1
                        kind: Naisjob
                        name: mynaisjob
                        uid: "123456"
                  spec:
                    containers:
                      - env:
                          - name: NAV_TRUSTSTORE_PATH
                            value: /etc/ssl/certs/java/cacerts
                          - name: NAV_TRUSTSTORE_PASSWORD
                            value: changeme
                          - name: NODE_EXTRA_CA_CERTS
                            value: /etc/pki/tls/certs/ca-bundle.crt
                          - name: NAIS_APP_NAME
                            value: mynaisjob
                          - name: NAIS_NAMESPACE
                            value: mynamespace
                          - name: NAIS_APP_IMAGE
                            value: navikt/mynaisjob:1.2.3
                          - name: NAIS_CLUSTER_NAME
                            value: test-cluster
                          - name: NAIS_CLIENT_ID
                            value: test-cluster:mynamespace:mynaisjob
                          - name: LOG4J_FORMAT_MSG_NO_LOOKUPS
                            value: "true"
                        image: navikt/mynaisjob:1.2.3
                        securityContext:
                          runAsUser: 1069
                          runAsGroup: 1069
                          allowPrivilegeEscalation: false
                          runAsNonRoot: true
                          readOnlyRootFilesystem: true
                          privileged: false
                          capabilities:
                            drop: ["ALL"]
                          seccompProfile:
                            type: RuntimeDefault
                        imagePullPolicy: IfNotPresent
                        lifecycle:
                          preStop:
                            exec:
                              command:
                                - sleep
                                - "5"
                        name: mynaisjob
                        resources:
                          limits:
                            cpu: 500m
                            memory: 512Mi
                          requests:
                            cpu: 200m
                            memory: 256Mi
                        volumeMounts:
                          - mountPath: /etc/ssl/certs/java/cacerts
                            name: ca-bundle-jks
                            readOnly: true
                            subPath: ca-bundle.jks
                          - mountPath: /etc/ssl/certs/ca-certificates.crt
                            name: ca-bundle-pem
                            readOnly: true
                            subPath: ca-bundle.pem
                          - mountPath: /etc/pki/tls/certs/ca-bundle.crt
                            name: ca-bundle-pem
                            readOnly: true
                            subPath: ca-bundle.pem
                          - mountPath: /etc/ssl/ca-bundle.pem
                            name: ca-bundle-pem
                            readOnly: true
                            subPath: ca-bundle.pem
                          - mountPath: /etc/pki/tls/cacert.pem
                            name: ca-bundle-pem
                            readOnly: true
                            subPath: ca-bundle.pem
                          - mountPath: /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem
                            name: ca-bundle-pem
                            readOnly: true
                            subPath: ca-bundle.pem
                          - mountPath: /tmp
                            name: writable-tmp
                    dnsPolicy: ClusterFirst
                    imagePullSecrets:
                      - name: gh-docker-credentials
                      - name: gar-docker-credentials
                    restartPolicy: Never
                    securityContext:
                      seccompProfile:
                        type: RuntimeDefault
                    serviceAccountName: mynaisjob
                    volumes:
                      - configMap:
                          name: ca-bundle-jks
                        name: ca-bundle-jks
                      - configMap:
                          name: ca-bundle-pem
                        name: ca-bundle-pem
                      - emptyDir: {}
                        name: writable-tmp
                    affinity:
                      podAntiAffinity:
                        preferredDuringSchedulingIgnoredDuringExecution:
                          - podAffinityTerm:
                              labelSelector:
                                matchExpressions:
                                  - key: app
                                    operator: In
                                    values:
                                    - mynaisjob
                              topologyKey: kubernetes.io/hostname
                            weight: 10
            schedule: "* 2 * * *"
            successfulJobsHistoryLimit: 3
