{
  "config": {
    "description": "vault enabled with default configuration",
    "matchType": "subset",
    "vaultEnabled": true,
    "match": {
      ".metadata": {
      },
      ".spec.template.spec.initContainers[].volume": [
        "subset"
      ],
      ".spec.template.spec.containers[].volumeMounts": [
        "subset"
      ],
      ".secretName": {
        "type": "regex",
        "match": "^appname-.\\w{8}$"
      }
    }
  },
  "input": {
    "kind": "Application",
    "apiVersion": "v1alpha1",
    "metadata": {
      "name": "myapplication",
      "namespace": "mynamespace",
      "uid": "123456",
      "labels": {
        "team": "myteam"
      }
    },
    "spec": {
      "vault": {
        "enabled": true
      }
    }
  },
  "output": [
    {
      "operation": "CreateOrUpdate",
      "resource": {
        "apiVersion": "apps/v1",
        "kind": "Deployment",
        "spec": {
          "template": {
            "spec": {
              "containers": [
                {
                  "volumeMounts": [
                    {
                      "name": "vault-volume",
                      "mountPath": "/var/run/secrets/nais.io/vault",
                      "subPath": "vault/var/run/secrets/nais.io/vault"
                    }
                  ]
                }
              ],
              "initContainers": [
                {
                  "name": "vks-init",
                  "image": "navikt/vault-sidekick:v0.3.10-d122b16",
                  "args": [
                    "-v=10",
                    "-logtostderr",
                    "-one-shot",
                    "-vault=https://vault.adeo.no",
                    "-save-token=/var/run/secrets/nais.io/vault/vault_token",
                    "-cn=secret:/kv/preprod/fss/myapplication/mynamespace:dir=/var/run/secrets/nais.io/vault,fmt=flatten,retries=1"
                  ],
                  "env": [
                    {
                      "name": "VAULT_AUTH_METHOD",
                      "value": "kubernetes"
                    },
                    {
                      "name": "VAULT_SIDEKICK_ROLE",
                      "value": "myapplication"
                    },
                    {
                      "name": "VAULT_K8S_LOGIN_PATH",
                      "value": "auth/kubernetes/preprod/fss/login"
                    }
                  ],
                  "volumeMounts": [
                    {
                      "name": "vault-volume",
                      "mountPath": "/var/run/secrets/nais.io/vault",
                      "subPath": "vault/var/run/secrets/nais.io/vault"
                    }
                  ]
                }
              ]
            }
          }
        }
      }
    }
  ]
}
